function MapsIndexShop(){var d=new L.LayerGroup(),e=new L.LayerGroup();var b=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[d,e]}).setView([-0.35764,0.11951],13);L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:true}).addTo(b);L.control.layers(null,{"Персонаж":d,"Магазины":e}).addTo(b);var h=L.icon({iconUrl:"/web/images/shop_book.png",iconSize:[38,38],iconAnchor:[19,19],popupAnchor:[0,-19]});var a=L.icon({iconUrl:"/web/images/shop_product.png",iconSize:[38,38],iconAnchor:[19,19],popupAnchor:[0,-19]});function c(m){var l=parseInt(m[0],10);m[0]=-(parseInt(m[1],10)-2607);m[1]=19920+l;return m}if(username){var i,f=0;var k=L.icon({iconUrl:"/api/head/"+username,iconSize:[32,32],iconAnchor:[16,16]});var g=setInterval(j,15000);j();function j(){$.getJSON("/api/user/world/"+username,function(l){var m=l.username.split(" ");var o=[m[0],m[2]];o=c(o);var n=b.unproject([o[0],o[1]],b.getMaxZoom());if(f++){i.setLatLng(n)}else{i=L.marker(n,{icon:k});d.addLayer(i);b.setView(n,15)}}).fail(function(){clearInterval(g);d.clearLayers()})}}$.getJSON("/api/shops",function(n){for(var l=n.length;l--;){if(n[l]["x_cord"]&&n[l]["z_cord"]){var p=[n[l]["x_cord"],n[l]["z_cord"]];p=c(p);var m='<div class="shop-popup"><h4><a href="/shop/'+n[l]["alias"]+'" target="_blank">'+n[l]["name"]+"</a></h4>";if(n[l]["image_url"]){m+='<img src="'+n[l]["image_url"]+'">'}m+="<p>"+n[l]["about"]+'</p><p class="plabel"><span class="label label-default">/go '+n[l]["subway"]+'</span></p><p class="plabel"><a href="/shop/'+n[l]["alias"]+'" target="_blank"><span class="label label-primary">Прайс</span></a> <span class="label label-success">X '+n[l]["x_cord"]+", Z "+n[l]["z_cord"]+"</span></p></div>";var o=L.marker(b.unproject([p[0],p[1]],b.getMaxZoom()),{icon:(n[l]["type"]==0?a:h)}).bindPopup(m);e.addLayer(o)}}}).fail(function(){$("#map").append('<div class="alert alert-danger" role="alert">Ошибка получения данных.</div>')})}function MapsUserRegions(){$("textarea.autosize").autosize();var b=0,j=0,f=0;var d=new L.LayerGroup(),g=new L.LayerGroup(),i=new L.LayerGroup();map=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[g,d,i]}).setView([-0.35764,0.11951],13);L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:true}).addTo(map);L.control.layers(null,{"Полный доступ":g,"Частичный доступ":d,"Добавленые регионы":i}).addTo(map);$.ajax({type:"GET",url:"/api/user/regions",dataType:"json",async:false,success:function(q){if(q.message=="You must be logged in"){$("#map").append('<div class="alert alert-danger" role="alert">Сбой ауторизации.</div>').height("52px");return}if(q.message=="It is a trouble with accessToken"){$("#map").append('<div class="alert alert-danger" role="alert">Ошибка Access_token-а, API GreenCubes не принимает наш ключик. Пишите Kernel-у.</div>').height("52px");return}if(q.message=="Rate limit exceeded, retry later"){$("#map").append('<div class="alert alert-warning" role="alert">Вы исчерпали лимит запросов к GreenCubes API, попробуйте позже.</div>').height("52px");return}for(var n=q.length;n--;){pos1=q[n]["coordinates"]["first"].split(" ");pos2=q[n]["coordinates"]["second"].split(" ");var m=Math.abs(pos1[0]-pos2[0]),p=Math.abs(pos1[1]-pos2[1]),o=Math.abs(pos1[2]-pos2[2]);b+=m*o;j+=m*p*o;f+=Math.round(m*o*10+(m*p*o*10)/256);e(pos1,pos2,q[n]);a()}}});function c(n){var m=parseInt(n[0],10);n[0]=-(parseInt(n[2],10)-2607);n[2]=19920+m;return n}function e(o,n,p){rights=(p.rights[0]==="full")?1:0;color=!rights?"blue":"red";o=c(o);n=c(n);var m=L.rectangle([map.unproject([o[0],o[2]],map.getMaxZoom()),map.unproject([n[0],n[2]],map.getMaxZoom())],{color:color,weight:3,fillOpacity:0.3});m.bindPopup("<b>"+p.name+'</b><br><a href="http://handbook.gctrade.ru/r:'+p.name+'" target="_blank">Информация о регионе</a>');m.on("click",function(){this.bringToBack()});if(rights){g.addLayer(m)}else{d.addLayer(m)}}function l(n,m){n=n.toString();if(n.length>m){return n.slice(0,m-3)+"..."}return n}function h(n,m){return n.toString().replace(/\d(?=(?:\d{3})+\b)/g,"$&"+(m||" "))}function a(){var m=$(".usermap dl.dl-horizontal");$("#area",m).text(h(b));$("#volume",m).text(h(j));$("#cost",m).text(h(f));$("#percent",m).text(l((b*100)/area_world,15))}$("#add-custom-regions").on("click",function(){var m=$("#customRegionTextarea").val();$("#customRegionModal").modal("hide");m=m.split(/(?:,| |;|\n)+/).toString();localStorage.customRegions=m;k()});$(document).ready(function(){if(localStorage.customRegions){$("#customRegionTextarea").val(localStorage.customRegions);k()}});function k(){var n=localStorage.customRegions.split(",");i.clearLayers();for(var m=n.length;m--;){$.ajax({type:"GET",url:"https://api.greencubes.org/main/regions/"+n[m],dataType:"json",success:function(q){if(q.name){pos1=c(q.coordinates["first"].split(" "));pos2=c(q.coordinates["second"].split(" "));var o=L.rectangle([map.unproject([pos1[0],pos1[2]],map.getMaxZoom()),map.unproject([pos2[0],pos2[2]],map.getMaxZoom())],{color:"orange",weight:3,fillOpacity:0.4});var p=q.parent?"<br><i>Родительский:</i> "+q.parent:"";o.bindPopup("<b>"+q.name+"</b>"+p+"<br><br><b>Владельцы:</b><br>"+q.full_access+"<br><b>Могут строить:</b><br>"+q.build_access);o.on("click",function(){this.bringToBack()});i.addLayer(o)}}})}}};