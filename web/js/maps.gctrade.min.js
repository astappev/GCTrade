function MapsIndexShop(){function a(a){var e=parseInt(a[0],10);return a[0]=-(parseInt(a[1],10)-2607),a[1]=19920+e,a}function e(){$.getJSON("/api/world/"+userLogin,function(e){if(1===e.status){var o=[e.player.x,e.player.z];o=a(o);var n=t.unproject([o[0],o[1]],t.getMaxZoom());i++?s.setLatLng(n):(s=L.marker(n,{icon:l}),r.addLayer(s),t.setView(n,15))}else clearInterval(p),r.clearLayers()})}var r=new L.LayerGroup,o=new L.LayerGroup,t=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[r,o]}).setView([-.35764,.11951],13);L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:!0}).addTo(t),L.control.layers(null,{"Персонаж":r,"Магазины":o}).addTo(t);var n=L.icon({iconUrl:"/web/images/shop.png",iconSize:[36,36],iconAnchor:[18,18],popupAnchor:[0,-18]});if(userLogin){var s,i=0,l=L.icon({iconUrl:"/api/head/"+userLogin,iconSize:[32,32],iconAnchor:[16,16]}),p=setInterval(e,15e3);e()}$.getJSON("/api/shop",function(e){for(var r=e.length;r--;)if(e[r].x_cord&&e[r].z_cord){var s=[e[r].x_cord,e[r].z_cord];s=a(s);var i='<div class="shop-popup"><h4><a href="/shop/'+e[r].alias+'" target="_blank">'+e[r].name+"</a></h4>";e[r].logo_url&&(i+='<img src="'+e[r].logo_url+'">'),i+="<p>"+e[r].about+'</p><p class="plabel"><span class="label label-default">/go '+e[r].subway+'</span></p><p class="plabel"><a href="/shop/'+e[r].alias+'" target="_blank"><span class="label label-primary">Прайс</span></a> <span class="label label-success">X '+e[r].x_cord+", Z "+e[r].z_cord+"</span></p></div>";var l=L.marker(t.unproject([s[0],s[1]],t.getMaxZoom()),{icon:n}).bindPopup(i);o.addLayer(l)}}).fail(function(){$("#map").append('<div class="alert alert-danger" role="alert">Ошибка получения данных.</div>')})}function MapsUserRegions(){function a(a){var e=parseInt(a[0],10);return a[0]=-(parseInt(a[2],10)-2607),a[2]=19920+e,a}function e(e,r,o){rights="full"===o.rights[0]?1:0,color=rights?"red":"blue",e=a(e),r=a(r);var t=L.rectangle([map.unproject([e[0],e[2]],map.getMaxZoom()),map.unproject([r[0],r[2]],map.getMaxZoom())],{color:color,weight:3,fillOpacity:.3});t.bindPopup("<b>"+o.name+'</b><br><a href="http://handbook.gctrade.ru/r:'+o.name+'" target="_blank">Информация о регионе</a>'),t.on("click",function(){this.bringToBack()}),rights?c.addLayer(t):p.addLayer(t)}function r(a,e){return a=a.toString(),a.length>e?a.slice(0,e-3)+"...":a}function o(a,e){return a.toString().replace(/\d(?=(?:\d{3})+\b)/g,"$&"+(e||" "))}function t(){var a=$(".usermap dl.dl-horizontal");$("#area",a).text(o(s)),$("#volume",a).text(o(i)),$("#cost",a).text(o(l)),$("#percent",a).text(r(100*s/area_world,15))}function n(){var e=localStorage.customRegions.split(",");u.clearLayers();for(var r=e.length;r--;)$.ajax({type:"GET",url:"https://api.greencubes.org/main/regions/"+e[r],dataType:"json",success:function(e){if(e.name){pos1=a(e.coordinates.first.split(" ")),pos2=a(e.coordinates.second.split(" "));var r=L.rectangle([map.unproject([pos1[0],pos1[2]],map.getMaxZoom()),map.unproject([pos2[0],pos2[2]],map.getMaxZoom())],{color:"orange",weight:3,fillOpacity:.4}),o=e.parent?"<br><i>Родительский:</i> "+e.parent:"";r.bindPopup("<b>"+e.name+"</b>"+o+"<br><br><b>Владельцы:</b><br>"+e.full_access+"<br><b>Могут строить:</b><br>"+e.build_access),r.on("click",function(){this.bringToBack()}),u.addLayer(r)}}})}var s=0,i=0,l=0,p=new L.LayerGroup,c=new L.LayerGroup,u=new L.LayerGroup;map=L.map("map",{maxZoom:15,minZoom:10,crs:L.CRS.Simple,layers:[c,p,u]}).setView([-.35764,.11951],13),L.tileLayer("http://maps.gctrade.ru/tiles/{z}/tile_{x}_{y}.png",{noWrap:!0}).addTo(map),L.control.layers(null,{"Полный доступ":c,"Частичный доступ":p,"Добавленые регионы":u}).addTo(map),$.ajax({type:"GET",url:"/api/regions",dataType:"json",async:!1,success:function(a){if("You must be logged in"==a.message)return void $("#map").append('<div class="alert alert-danger" role="alert">Сбой ауторизации.</div>').height("52px");if("It is a trouble with accessToken"==a.message)return void $("#map").append('<div class="alert alert-danger" role="alert">Ошибка Access_token-а, API GreenCubes не принимает наш ключик. Пишите Kernel-у.</div>').height("52px");if("Rate limit exceeded, retry later"==a.message)return void $("#map").append('<div class="alert alert-warning" role="alert">Вы исчерпали лимит запросов к GreenCubes API, попробуйте позже.</div>').height("52px");for(var r=a.length;r--;){pos1=a[r].coordinates.first.split(" "),pos2=a[r].coordinates.second.split(" ");var o=Math.abs(pos1[0]-pos2[0]),n=Math.abs(pos1[1]-pos2[1]),p=Math.abs(pos1[2]-pos2[2]);s+=o*p,i+=o*n*p,l+=Math.round(o*p*10+o*n*p*10/256),e(pos1,pos2,a[r]),t()}}}),$("#add-custom-regions").on("click",function(){var a=$("#customRegionTextarea").val();$("#customRegionModal").modal("hide"),a=a.split(/(?:,| |;|\n)+/).toString(),localStorage.customRegions=a,n()}),$(document).ready(function(){localStorage.customRegions&&($("#customRegionTextarea").val(localStorage.customRegions),n())})}$("textarea.autosize").autosize();
