var isGCRC=(localStorage.getItem("isGCRC")==1||localStorage.getItem("isGCRC")==null)?1:0;function getJsonGCMap(b){var a=$.ajax({type:"GET",url:b,async:false,dataType:"json"}).responseText;if(a==""||!a){$(".breadcrumb").after('<div id="w7-danger" class="alert-danger alert fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>Нет связи с сервером <a href="http://gcmap.ru" target="_blank" rel="tooltip" title="Карта сервера GreenCubes">gcmap.ru</a>, прошу прощение за временные неудобства.</div>')}return $.parseJSON(a)}function union_line(c,b){for(var a in b){c.push(b[a])}return c}var planned=getJsonGCMap("http://gcmap.ru/api/metro/lines/type/indigo");var barred=getJsonGCMap("http://gcmap.ru/api/metro/lines/type/black");var unfinished=getJsonGCMap("http://gcmap.ru/api/metro/lines/type/yellow");var line=(isGCRC)?getJsonGCMap("http://gcmap.ru/api/metro/lines/type/blue"):getJsonGCMap("http://gcmap.ru/api/metro/lines/type/default");var cross=(isGCRC)?getJsonGCMap("http://gcmap.ru/api/metro/blocks/type/s_cross"):getJsonGCMap("http://gcmap.ru/api/metro/blocks/type/cross");var station=(isGCRC)?getJsonGCMap("http://gcmap.ru/api/metro/blocks/type/s_station"):getJsonGCMap("http://gcmap.ru/api/metro/blocks/type/station");var turn=(isGCRC)?getJsonGCMap("http://gcmap.ru/api/metro/blocks/type/s_turn"):getJsonGCMap("http://gcmap.ru/api/metro/blocks/type/turn");var all_line=union_line(line,union_line(planned,union_line(barred,unfinished)));function find_block(b){for(var a in turn){if(turn[a].cb_id==b){return turn[a]}}for(var a in station){if(station[a].cb_id==b){return station[a]}}for(var a in cross){if(cross[a].cb_id==b){return cross[a]}}return 0}function find_line(b){for(var a in all_line){if(all_line[a]._to==b||all_line[a]._from==b){return all_line[a]}}return 0}function count_length_line(){var b=0;for(var a in line){var d=find_block(line[a]._from);var c=find_block(line[a]._to);if(d!=0&&c!=0){b+=(Math.abs(d.x-c.x)+Math.abs(d.z-c.z))}}return b}function station_owner(){var a={};for(var b in station){if(station[b].owner!=""){if(!a[station[b].owner]){a[station[b].owner]=1}else{a[station[b].owner]++}}}return a}function courators_list(){var a=station_owner();var c="";for(var b in Object.keys(a)){if(b!=Object.keys(a).length-1){c+=Object.keys(a)[b]+" ("+a[Object.keys(a)[b]]+"), "}else{c+=Object.keys(a)[b]+" ("+a[Object.keys(a)[b]]+")"}}return c}function local_areas(){var c="";var b={};for(var a in station){if(/^[A-Za-z0-9]{1,6}_/gi.test(station[a].name)&&!(/^[hnwsre]_/gi.test(station[a].name))){if(!b[station[a].name.split("_")[0]]){b[station[a].name.split("_")[0]]=1}else{b[station[a].name.split("_")[0]]++}}}for(var a in Object.keys(b)){if(b[Object.keys(b)[a]]>1){if(a!=Object.keys(b).length-1){c+=Object.keys(b)[a]+"_ ("+b[Object.keys(b)[a]]+"), "}else{c+=Object.keys(b)[a]+"_ ("+b[Object.keys(b)[a]]+")"}}}return c}function station_list(){var b="";station.sort(function(d,c){if(d.name<c.name){return -1}if(d.name>c.name){return 1}return 0});for(var a in station){if(station[a].name!=""){if(a!=station.length-1){b+=station[a].name+", "}}b+=station[a].name}return b}function station_without_names(){var b=[];for(var a in station){if(station[a].name==""||station[a].name=="new station"){b.push(station[a])}}return b}function station_without_names_list(){var a=station_without_names();var c="";for(var b in a){c+="Номер cb: "+a[b].cb_id+".   Координаты (x, z): ("+a[b].x+", "+a[b].z+");</br>"}return c}function cb_bad_id(){var b=[];for(var a in station){if(station[a].cb_id>10000||station[a].cb_id<0){b.push(station[a])}}for(var a in cross){if(cross[a].cb_id>10000||cross[a].cb_id<0){b.push(cross[a])}}return b}function cb_bad_id_list(){var a=cb_bad_id();var c="";for(var b in a){c+="Номер cb: "+a[b].cb_id+".   Координаты (x, z): ("+a[b].x+", "+a[b].z+");</br>"}return c}function cb_without_owners(){var b=[];for(var a in cross){if(cross[a].owner==""){b.push(cross[a])}}for(var a in station){if(station[a].owner==""){b.push(station[a])}}return b}function cb_without_owners_list(){var a=cb_without_owners();var c="";for(var b in a){c+="Номер cb: "+a[b].cb_id+".   Координаты (x, z): ("+a[b].x+", "+a[b].z+");</br>"}return c}function cb_not_line(){var b=[];for(var a in station){if(!find_line(station[a].cb_id)){b.push(station[a])}}for(var a in cross){if(!find_line(cross[a].cb_id)){b.push(cross[a])}}for(var a in turn){if(!find_line(turn[a].cb_id)){b.push(turn[a])}}return b}function cb_not_line_list(){var a=cb_not_line();var c="";for(var b in a){c+="Номер cb: "+a[b].cb_id+".   Координаты (x, z): ("+a[b].x+", "+a[b].z+");</br>"}return c}function command_cb(e){var f="";var b=e;var g=find_block(b);var h=[];for(var d in all_line){if(all_line[d]._from==b||all_line[d]._to==b){h=(all_line[d]._from==b)?find_block(all_line[d]._to):find_block(all_line[d]._from);if(h.type=="s_turn"||h.type=="turn"){var a=g;var k=h;while(k.type=="s_turn"||k.type=="turn"){for(var c in all_line){if((all_line[c]._to==k.cb_id&&all_line[c]._from!=a.cb_id)||(all_line[c]._from==k.cb_id&&all_line[c]._to!=a.cb_id)){a=k;k=(all_line[c]._from==a.cb_id)?find_block(all_line[c]._to):find_block(all_line[c]._from)}}}if(g.x>h.x){f+="/cb cfg "+g.cb_id+" n "+k.cb_id+"<br/>"}else{if(g.x<h.x){f+="/cb cfg "+g.cb_id+" s "+k.cb_id+"<br/>"}else{if(g.z>h.z){f+="/cb cfg "+g.cb_id+" e "+k.cb_id+"<br/>"}else{if(g.z<h.z){f+="/cb cfg "+g.cb_id+" w "+k.cb_id+"<br/>"}}}}if(a.x>k.x){f+="/cb cfg "+k.cb_id+" s 0<br/>";f+="/cb cfg "+k.cb_id+" s "+g.cb_id+"<br/>"}else{if(a.x<k.x){f+="/cb cfg "+k.cb_id+" n 0<br/>";f+="/cb cfg "+k.cb_id+" n "+g.cb_id+"<br/>"}else{if(a.z>k.z){f+="/cb cfg "+k.cb_id+" w 0<br/>";f+="/cb cfg "+k.cb_id+" w "+g.cb_id+"<br/>"}else{if(a.z<k.z){f+="/cb cfg "+k.cb_id+" e 0<br/>";f+="/cb cfg "+k.cb_id+" e "+g.cb_id+"<br/>"}}}}}else{if(g.x>h.x){f+="/cb cfg "+g.cb_id+" n "+h.cb_id+"<br/>";f+="/cb cfg "+h.cb_id+" s 0<br/>";f+="/cb cfg "+h.cb_id+" s "+g.cb_id+"<br/>"}else{if(g.x<h.x){f+="/cb cfg "+g.cb_id+" s "+h.cb_id+"<br/>";f+="/cb cfg "+h.cb_id+" n 0<br/>";f+="/cb cfg "+h.cb_id+" n "+g.cb_id+"</p>"}else{if(g.z>h.z){f+="/cb cfg "+g.cb_id+" e "+h.cb_id+"<br/>";f+="/cb cfg "+h.cb_id+" w 0<br/>";f+="/cb cfg "+h.cb_id+" w "+g.cb_id+"<br/>"}else{if(g.z<h.z){f+="/cb cfg "+g.cb_id+" w "+h.cb_id+"<br/>";f+="/cb cfg "+h.cb_id+" e 0<br/>";f+="/cb cfg "+h.cb_id+" e "+g.cb_id+"<br/>"}}}}}f+="<br/>"}}if((g.type=="s_station"||g.type=="station")&&g.name!=""){f+="/st create "+g.name+"<br/>";f+="/cb cfg "+g.cb_id+" st "+g.name+"<br/>";f+="/cb cfg "+g.cb_id+" arr t<br/>";f+="/cb cfg "+g.cb_id+" dep t<br/>"}return f}$(document).ready(function(){if(isGCRC){$("label#gcrc").addClass("active")}else{$("label#metro").addClass("active")}$("label#gcrc").click(function(){if(isGCRC==0){localStorage.setItem("isGCRC","1");location.reload()}});$("label#metro").click(function(){if(isGCRC==1){localStorage.setItem("isGCRC","0");location.reload()}});$("dt#length_line").append(count_length_line());$("dt#cb_count").append(station.length+cross.length);$("dt#courators_count").append(Object.keys(station_owner()).length);$("dt#station_count").append(station.length);$("#courators_list").append(courators_list());$("#station_list").append(station_list());$("#local_areas").append(local_areas());$("#st_bad_list_counter").append(station_without_names().length);$("#st_bad_list .panel-body").append(station_without_names_list());$("#cb_bad_list_counter").append(cb_bad_id().length);$("#cb_bad_list .panel-body").append(cb_bad_id_list());$("#cb_not_owner_counter").append(cb_without_owners().length);$("#cb_not_owner .panel-body").append(cb_without_owners_list());$("#not_line_counter").append(cb_not_line().length);$("#not_line .panel-body").append(cb_not_line_list());$("#find_cb_owner button").click(function(){var a=$("#find_cb_owner input").val();var b=[];for(var d in cross){if(cross[d].owner==a){b.push(cross[d])}}for(var d in station){if(station[d].owner==a){b.push(station[d])}}var c="";for(var d in b){c+="Номер cb: "+b[d].cb_id+".   Координаты (x, z): ("+b[d].x+", "+b[d].z+");</br>"}$("p#find_cb_owner").empty().append(c)});$("#full_info_cb button").click(function(){var a=find_block($("#full_info_cb input").val());var b="Название кб: ";if(a.name!=""){b+=a.name}else{b+="нет названия"}b+=";<br>";b+="Номер cb: "+a.cb_id+";<br/>Координаты (x, z): ("+a.x+", "+a.z+");</br>Владелец: ";if(a.owner!=""){b+=a.owner}else{b+="нет владельца"}b+=";<br>";$("p#full_info_cb").empty().append(b)});$("#config_cb button").click(function(){var b=$("#config_cb input").val();var a="";if(find_block(b).type=="s_turn"||find_block(b).type=="turn"){a+="Блоки данного типа (Повороты), не поддерживаются!"}else{a+=command_cb(b)}$("pre#config_cb").empty().append(a)})});