function getJsonGCMap(t){var n=$.ajax({type:"GET",url:t,async:!1,dataType:"json"}).responseText;return""!=n&&n||$(".breadcrumb").after('<div id="w7-danger" class="alert-danger alert fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>Нет связи с сервером <a href="http://gcmap.ru" target="_blank" rel="tooltip" title="Карта сервера GreenCubes">gcmap.ru</a>, прошу прощение за временные неудобства.</div>'),$.parseJSON(n)}function union_line(t,n){for(var i in n)t.push(n[i]);return t}function find_block(t){for(var n in turn)if(turn[n].cb_id==t)return turn[n];for(var n in station)if(station[n].cb_id==t)return station[n];for(var n in cross)if(cross[n].cb_id==t)return cross[n];return 0}function find_line(t){for(var n in all_line)if(all_line[n]._to==t||all_line[n]._from==t)return all_line[n];return 0}function count_length_line(){var t=0;for(var n in line){var i=find_block(line[n]._from),r=find_block(line[n]._to);0!=i&&0!=r&&(t+=Math.abs(i.x-r.x)+Math.abs(i.z-r.z))}return t}function station_owner(){var t={};for(var n in station)""!=station[n].owner&&(t[station[n].owner]?t[station[n].owner]++:t[station[n].owner]=1);return t}function courators_list(){var t=station_owner(),n="";for(var i in Object.keys(t))n+=i!=Object.keys(t).length-1?Object.keys(t)[i]+" ("+t[Object.keys(t)[i]]+"), ":Object.keys(t)[i]+" ("+t[Object.keys(t)[i]]+")";return n}function local_areas(){var t="",n={};for(var i in station)/^[A-Za-z0-9]{1,6}_/gi.test(station[i].name)&&!/^[hnwsre]_/gi.test(station[i].name)&&(n[station[i].name.split("_")[0]]?n[station[i].name.split("_")[0]]++:n[station[i].name.split("_")[0]]=1);for(var i in Object.keys(n))n[Object.keys(n)[i]]>1&&(t+=i!=Object.keys(n).length-1?Object.keys(n)[i]+"_ ("+n[Object.keys(n)[i]]+"), ":Object.keys(n)[i]+"_ ("+n[Object.keys(n)[i]]+")");return t}function station_list(){var t="";station.sort(function(t,n){return t.name<n.name?-1:t.name>n.name?1:0});for(var n in station)""!=station[n].name&&n!=station.length-1&&(t+=station[n].name+", "),t+=station[n].name;return t}function station_without_names(){var t=[];for(var n in station)(""==station[n].name||"new station"==station[n].name)&&t.push(station[n]);return t}function station_without_names_list(){var t=station_without_names(),n="";for(var i in t)n+="Номер cb: "+t[i].cb_id+".   Координаты (x, z): ("+t[i].x+", "+t[i].z+");</br>";return n}function cb_bad_id(){var t=[];for(var n in station)(station[n].cb_id>1e4||station[n].cb_id<0)&&t.push(station[n]);for(var n in cross)(cross[n].cb_id>1e4||cross[n].cb_id<0)&&t.push(cross[n]);return t}function cb_bad_id_list(){var t=cb_bad_id(),n="";for(var i in t)n+="Номер cb: "+t[i].cb_id+".   Координаты (x, z): ("+t[i].x+", "+t[i].z+");</br>";return n}function cb_without_owners(){var t=[];for(var n in cross)""==cross[n].owner&&t.push(cross[n]);for(var n in station)""==station[n].owner&&t.push(station[n]);return t}function cb_without_owners_list(){var t=cb_without_owners(),n="";for(var i in t)n+="Номер cb: "+t[i].cb_id+".   Координаты (x, z): ("+t[i].x+", "+t[i].z+");</br>";return n}function cb_not_line(){var t=[];for(var n in station)find_line(station[n].cb_id)||t.push(station[n]);for(var n in cross)find_line(cross[n].cb_id)||t.push(cross[n]);for(var n in turn)find_line(turn[n].cb_id)||t.push(turn[n]);return t}function cb_not_line_list(){var t=cb_not_line(),n="";for(var i in t)n+="Номер cb: "+t[i].cb_id+".   Координаты (x, z): ("+t[i].x+", "+t[i].z+");</br>";return n}function command_cb(t){var n="",i=t,r=find_block(i),e=[];for(var c in all_line)if(all_line[c]._from==i||all_line[c]._to==i){if(e=find_block(all_line[c]._from==i?all_line[c]._to:all_line[c]._from),"s_turn"==e.type||"turn"==e.type){for(var a=r,o=e;"s_turn"==o.type||"turn"==o.type;)for(var s in all_line)(all_line[s]._to==o.cb_id&&all_line[s]._from!=a.cb_id||all_line[s]._from==o.cb_id&&all_line[s]._to!=a.cb_id)&&(a=o,o=find_block(all_line[s]._from==a.cb_id?all_line[s]._to:all_line[s]._from));r.x>e.x?n+="/cb cfg "+r.cb_id+" n "+o.cb_id+"<br/>":r.x<e.x?n+="/cb cfg "+r.cb_id+" s "+o.cb_id+"<br/>":r.z>e.z?n+="/cb cfg "+r.cb_id+" e "+o.cb_id+"<br/>":r.z<e.z&&(n+="/cb cfg "+r.cb_id+" w "+o.cb_id+"<br/>"),a.x>o.x?(n+="/cb cfg "+o.cb_id+" s 0<br/>",n+="/cb cfg "+o.cb_id+" s "+r.cb_id+"<br/>"):a.x<o.x?(n+="/cb cfg "+o.cb_id+" n 0<br/>",n+="/cb cfg "+o.cb_id+" n "+r.cb_id+"<br/>"):a.z>o.z?(n+="/cb cfg "+o.cb_id+" w 0<br/>",n+="/cb cfg "+o.cb_id+" w "+r.cb_id+"<br/>"):a.z<o.z&&(n+="/cb cfg "+o.cb_id+" e 0<br/>",n+="/cb cfg "+o.cb_id+" e "+r.cb_id+"<br/>")}else r.x>e.x?(n+="/cb cfg "+r.cb_id+" n "+e.cb_id+"<br/>",n+="/cb cfg "+e.cb_id+" s 0<br/>",n+="/cb cfg "+e.cb_id+" s "+r.cb_id+"<br/>"):r.x<e.x?(n+="/cb cfg "+r.cb_id+" s "+e.cb_id+"<br/>",n+="/cb cfg "+e.cb_id+" n 0<br/>",n+="/cb cfg "+e.cb_id+" n "+r.cb_id+"</p>"):r.z>e.z?(n+="/cb cfg "+r.cb_id+" e "+e.cb_id+"<br/>",n+="/cb cfg "+e.cb_id+" w 0<br/>",n+="/cb cfg "+e.cb_id+" w "+r.cb_id+"<br/>"):r.z<e.z&&(n+="/cb cfg "+r.cb_id+" w "+e.cb_id+"<br/>",n+="/cb cfg "+e.cb_id+" e 0<br/>",n+="/cb cfg "+e.cb_id+" e "+r.cb_id+"<br/>");n+="<br/>"}return"s_station"!=r.type&&"station"!=r.type||""==r.name||(n+="/st create "+r.name+"<br/>",n+="/cb cfg "+r.cb_id+" st "+r.name+"<br/>",n+="/cb cfg "+r.cb_id+" arr t<br/>",n+="/cb cfg "+r.cb_id+" dep t<br/>"),n}var isGCRC=1==localStorage.getItem("isGCRC")||null==localStorage.getItem("isGCRC")?1:0,planned=getJsonGCMap("http://gcmap.ru/api/metro/lines/type/indigo"),barred=getJsonGCMap("http://gcmap.ru/api/metro/lines/type/black"),unfinished=getJsonGCMap("http://gcmap.ru/api/metro/lines/type/yellow"),line=getJsonGCMap(isGCRC?"http://gcmap.ru/api/metro/lines/type/blue":"http://gcmap.ru/api/metro/lines/type/default"),cross=getJsonGCMap(isGCRC?"http://gcmap.ru/api/metro/blocks/type/s_cross":"http://gcmap.ru/api/metro/blocks/type/cross"),station=getJsonGCMap(isGCRC?"http://gcmap.ru/api/metro/blocks/type/s_station":"http://gcmap.ru/api/metro/blocks/type/station"),turn=getJsonGCMap(isGCRC?"http://gcmap.ru/api/metro/blocks/type/s_turn":"http://gcmap.ru/api/metro/blocks/type/turn"),all_line=union_line(line,union_line(planned,union_line(barred,unfinished)));$(document).ready(function(){isGCRC?$("label#gcrc").addClass("active"):$("label#metro").addClass("active"),$("label#gcrc").click(function(){0==isGCRC&&(localStorage.setItem("isGCRC","1"),location.reload())}),$("label#metro").click(function(){1==isGCRC&&(localStorage.setItem("isGCRC","0"),location.reload())}),$("dt#length_line").append(count_length_line()),$("dt#cb_count").append(station.length+cross.length),$("dt#courators_count").append(Object.keys(station_owner()).length),$("dt#station_count").append(station.length),$("#courators_list").append(courators_list()),$("#station_list").append(station_list()),$("#local_areas").append(local_areas()),$("#st_bad_list_counter").append(station_without_names().length),$("#st_bad_list .panel-body").append(station_without_names_list()),$("#cb_bad_list_counter").append(cb_bad_id().length),$("#cb_bad_list .panel-body").append(cb_bad_id_list()),$("#cb_not_owner_counter").append(cb_without_owners().length),$("#cb_not_owner .panel-body").append(cb_without_owners_list()),$("#not_line_counter").append(cb_not_line().length),$("#not_line .panel-body").append(cb_not_line_list()),$("#find_cb_owner button").click(function(){var t=$("#find_cb_owner input").val(),n=[];for(var i in cross)cross[i].owner==t&&n.push(cross[i]);for(var i in station)station[i].owner==t&&n.push(station[i]);var r="";for(var i in n)r+="Номер cb: "+n[i].cb_id+".   Координаты (x, z): ("+n[i].x+", "+n[i].z+");</br>";$("p#find_cb_owner").empty().append(r)}),$("#full_info_cb button").click(function(){var t=find_block($("#full_info_cb input").val()),n="Название кб: ";n+=""!=t.name?t.name:"нет названия",n+=";<br>",n+="Номер cb: "+t.cb_id+";<br/>Координаты (x, z): ("+t.x+", "+t.z+");</br>Владелец: ",n+=""!=t.owner?t.owner:"нет владельца",n+=";<br>",$("p#full_info_cb").empty().append(n)}),$("#config_cb button").click(function(){var t=$("#config_cb input").val(),n="";n+="s_turn"==find_block(t).type||"turn"==find_block(t).type?"Блоки данного типа (Повороты), не поддерживаются!":command_cb(t),$("pre#config_cb").empty().append(n)})});
