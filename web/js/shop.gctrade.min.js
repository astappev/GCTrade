var avg_price={price:[],init:function(){$.ajax({url:"/cpanel/shop/good/avg",dataType:"json",success:function(a){avg_price.price=a;avg_price.update()}})},update:function(){if(avg_price.price.length===0){avg_price.init()}else{$("table.avg-list > tbody tr").each(function(){var c=$("td",this).eq(1).text();var a=$("td",this).eq(7).text();var d=(avg_price.price[c].price_sell*a).toFixed(2);var b=(avg_price.price[c].price_buy*a).toFixed(2);$("td",this).eq(4).addClass($("td",this).eq(3).text()<=+d?"bg-success":"bg-danger").text(d);$("td",this).eq(6).addClass($("td",this).eq(5).text()>=+b?"bg-success":"bg-danger").text(b)})}}};$("input#file-import-good").on("change",function(c){var b=$("table#add-item-table",$(this).parents(".modal"));var d=$(this).val().split(".").pop().toLowerCase();if($.inArray(d,["csv","txt"])==-1){b.before('<p class="error-type">Загружаемый файл должен быть типа CSV или TXT</p>');return false}if(c.target.files!=undefined){var a=new FileReader();a.onload=function(n){var f=n.target.result.split("\n");b.show();for(var k=0;k<f.length;k++){f[k]=$.trim(f[k]);if(f[k].slice(-1)==";"){f[k]=f[k].substring(0,f[k].length-1)}var l=f[k].split(/,|;/);if(l.length==4){var m='<tr id="'+l[0]+'">';for(var h=0;h<l.length;h++){var g=l[h].replace(/\s/g,"");if(g=="null"){g="—"}if(h==0){m+='<td><img src="/images/items/'+g+'.png" class="small-icon"/></td>'}else{m+="<td>"+g+"</td>"}}m+='<td class="sp"></td></tr>';$("tbody",b).append(m)}}};a.readAsText(c.target.files.item(0))}return false});$("form#add-item-form").on("submit",function(g){var c=$("table#add-item-table",$(this).parents(".modal"));var b=$("input#item_id").val().replace(",",".");var d=$("input#price_sell").val();var a=$("input#price_buy").val();var f=$("input#stuck").val();if(b&&f&&(d||a)){c.show().children("tbody").append('<tr id="'+b+'"><td><img src="/images/items/'+b+'.png" class="small-icon"/></td><td>'+(d||"—")+"</td><td>"+(a||"—")+"</td><td>"+f+'</td><td id="sp"></td></tr>');$("form#add-item-form").trigger("reset");$("p#error-item-form").empty()}else{if(!b){$("p#error-item-form").text("Необходимо заполнить «ID товара».")}else{if(!(d||a)){$("p#error-item-form").text("Необходимо заполнить «Цена продажи» и/или «Цена пакупки».")}else{if(!f){$("p#error-item-form").text("Необходимо заполнить «Кол-во».")}}}}return false});$("button#submit-item-form").on("click",function(){var a=$("table#add-item-table > tbody",$(this).parents(".modal"));var c=$("input#shop_id-form-good").val();var b=$("input#token-form-good").val();$("td.sp",a).spin("show");console.log("hi-1");$("tr",a).each(function(e){console.log("hi-2",e);var d=this;var f=setTimeout(function(){var h=$("td",d).eq(1).text();var g=$("td",d).eq(2).text();$.ajax({type:"POST",url:"/cpanel/shop/good/create",cache:false,async:false,dataType:"json",data:"_csrf="+b+"&&Good%5Bshop_id%5D="+c+"&Good%5Bitem_id%5D="+$(d).attr("id")+"&Good%5Bprice_buy%5D="+(g==="—"?"":g)+"&Good%5Bprice_sell%5D="+(h==="—"?"":h)+"&Good%5Bstuck%5D="+$("td",d).eq(3).text(),success:function(i){console.log(i);$("td",d).eq(4).html('<span class="glyphicon glyphicon-'+(i.status==1?"ok-circle green":(i.status==2?"refresh blue":"ban-circle red"))+' twosize" data-toggle="tooltip" title="'+i.message+'"></span>')}})},100*e)})});$("button#submit-edit-form").on("click",function(){$("form#edit-item-form").submit()});$("form#edit-item-form").on("submit",function(c){var a=$(this);var b=$("#submit-edit-form");var d=a.serialize();b.addClass("disabled");$.ajax({type:"POST",url:"/cpanel/shop/good/create",cache:false,async:false,dataType:"json",data:d,success:function(f){if(f.status==2){var e=$("table.item-list tr#item_"+f.id);$("td",e).eq(3).text($('input[name="Good[price_sell]"]',a).val()||"—");$("td",e).eq(5).text($('input[name="Good[price_buy]"]',a).val()||"—");$("td",e).eq(7).text($('input[name="Good[stuck]"]',a).val());a.trigger("reset");$(".item-edit-modal").modal("hide");avg_price.update();c.stopImmediatePropagation()}}});b.removeClass("disabled");c.preventDefault()});$(".item-modal").on("hidden.bs.modal",function(){location.reload()});$(".import-good-modal").on("hidden.bs.modal",function(){location.reload()});$("button#submit-book-form").on("click",function(){$("form#add-book-form").submit()});$(".book-modal").on("hidden.bs.modal",function(){if($("input#book-id",this).val()){$("form",this).trigger("reset");$("input#book-id",this).val("")}});$("form#add-book-form").on("submit",function(c){var a=$(this);var b=$("#submit-book-form");var d=a.serialize();b.addClass("disabled");$.ajax({type:"POST",url:"/cpanel/shop/book/create",cache:false,async:false,dataType:"json",data:d,success:function(f){if(f.status==1){if($("#empty-items").length){location.reload()}else{$("table.item-list tr:last").after('<tr id="item_'+f.id+'">                        <td><img src="/images/items/'+$('select[name="Book[item_id]"]',a).val()+'.png" alt="Книга с текстом" class="small-icon"></td>                        <td class="name">'+$('input[name="Book[name]"]',a).val()+'</td>                        <td class="name">'+$('input[name="Book[author]"]',a).val()+"</td>                        <td>"+($('input[name="Book[price_sell]"]',a).val()||"—")+'</td>                        <td class="control">                            <div class="btn-group btn-group-sm">                                <button class="btn btn-primary edit-book-buttons" title="Редактировать"><span class="glyphicon glyphicon-pencil"></span></button>                                <button class="btn btn-danger remove-book-buttons" title="Удалить"><span class="glyphicon glyphicon-remove"></span></button>                            </div>                        </td>                    </tr>');a.trigger("reset");$(".book-modal").modal("hide")}c.stopImmediatePropagation()}else{if(f.status==2){var e=$("table.item-list tr#item_"+f.id);$("td",e).eq(0).html('<img src="/images/items/'+$('select[name="Book[item_id]"]',a).val()+'.png" alt="Книга с текстом" class="small-icon">');$("td",e).eq(1).text($('input[name="Book[name]"]',a).val());$("td",e).eq(2).text($('input[name="Book[author]"]',a).val());$("td",e).eq(3).text($('input[name="Book[price_sell]"]',a).val()||"—");a.trigger("reset");$(".book-modal").modal("hide");c.stopImmediatePropagation()}}}});b.removeClass("disabled");c.preventDefault()});$("select#book-item_id").on("change",function(){var a=$(this).parents("form");$('label[for="book-item_id"] img',a).attr("src","/images/items/"+$(this).val()+".png")});$("body").on("click","button.remove-book-buttons",function(){var a=$(this).parents("tr");$.get("/cpanel/shop/book/delete",{id:a.attr("id").split("_")[1]}).done(function(){a.hide("slow",function(){a.remove()})})}).on("click","button.edit-book-buttons",function(){var a=$(this).parents("tr");$.ajax({url:"/cpanel/shop/book/view",async:false,dataType:"json",data:{id:a.attr("id").split("_")[1]},success:function(d){var c=$(".book-modal");var b=$("form",c);c.modal("show");$("input#book-id",b).val(d.model.id);$("select#book-item_id",b).val(d.model.item_id);$('label[for="book-item_id"] img',b).attr("src","/images/items/"+d.model.item_id+".png");$("input#book-name",b).val(d.model.name);$("input#book-author",b).val(d.model.author);$("textarea#book-description",b).html(d.model.description);$("input#book-price_sell",b).val(d.model.price_sell)}})}).on("click","button.remove-item-buttons",function(){var a=$(this).parents("tr");$.get("/cpanel/shop/good/delete",{id:a.attr("id").split("_")[1]}).done(function(){a.hide("slow",function(){a.remove()})})}).on("click","button.edit-item-buttons",function(){var a=$(this).parents("tr");$.ajax({url:"/cpanel/shop/good/view",async:false,dataType:"json",data:{id:a.attr("id").split("_")[1]},success:function(d){var c=$(".item-edit-modal");var b=$("form",c);c.modal("show");$("input#good-id",b).val(d.model.id);$("input#good-item_id",b).val(d.model.item_id);$('label[for="good-item_id"] img',b).attr("src","/images/items/"+d.model.item_id+".png");$("input#good-price_sell",b).val(d.model.price_sell);$("input#good-price_buy",b).val(d.model.price_buy);$("input#good-stuck",b).val(d.model.stuck)}})}).ready(function(){if($("table.avg-list").length){avg_price.update()}});$("input#file-import-book").on("change",function(b){var c=$(this).val().split(".").pop().toLowerCase();if($.inArray(c,["csv","txt"])==-1){$("table#import-book-table").before('<p class="error-type">Загружаемый файл должен быть типа CSV или TXT</p>');return false}if(b.target.files!=undefined){var a=new FileReader();a.onload=function(m){var d=m.target.result.split("\n");$("table#import-book-table").show();for(var h=0;h<d.length;h++){d[h]=$.trim(d[h]);if(d[h].slice(-1)==";"){d[h]=d[h].substring(0,d[h].length-1)}var k=d[h].split(/,|;/);if(k.length==5){var l='<tr id="'+k[0]+'">';for(var g=0;g<k.length;g++){var f=k[g].replace(/\s/g,"");if(f=="null"){f="—"}if(g==0){l+='<td><img src="/images/items/'+f+'.png" class="small-icon"/></td>'}else{l+="<td>"+f+"</td>"}}l+='<td class="sp"></td></tr>';$("table#import-book-table tbody").append(l)}}};a.readAsText(b.target.files.item(0))}return false});$("button#import-book").on("click",function(){var a=$("table#import-book-table > tbody");var c=$("input#shop-import-book").val();var b=$("input#token-import-book").val();$("td.sp",a).spin("show");$("tr",a).each(function(e){var d=this;var f=setTimeout(function(){var g=$("td",d).eq(4).text();$.ajax({type:"POST",url:"/cpanel/shop/book/create",cache:false,async:false,dataType:"json",data:"_csrf="+b+"&&Book%5Bshop_id%5D="+c+"&Book%5Bitem_id%5D="+$(d).attr("id")+"&Book%5Bname%5D="+$("td",d).eq(1).text()+"&Book%5Bauthor%5D="+$("td",d).eq(2).text()+"&Book%5Bdescription%5D="+$("td",d).eq(3).text()+"&Book%5Bprice_sell%5D="+(g==="—"?"":g),success:function(h){$("td",d).eq(5).html('<span class="glyphicon glyphicon-'+(h.status==1?"ok-circle green":(h.status==2?"refresh blue":"ban-circle red"))+' twosize" data-toggle="tooltip" title="'+h.message+'"></span>')}})},100*e)})});$(".import-book-modal").on("hidden.bs.modal",function(){location.reload()});