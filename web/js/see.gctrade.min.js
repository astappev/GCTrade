var user={online:[],update:function(){return $(".table > tbody > tr").each(function(e){var t=this;setTimeout(function(){var e=$("td",t).eq(0).text();$.ajax({url:"https://api.greencubes.org/users/"+e,type:"GET",dataType:"json",success:function(i){if(i.status.main){if(!user.online[e]){var n=$("td",t).eq(1).text(),a="Пользователь "+e+", зашел поиграть!";new Notification(a,{tag:"gc-see",body:n,icon:"/images/see.png"}),user.online[e]=!0}$("td",t).eq(2).html('<span class="label label-info">В сети</span>')}else{user.online[e]&&(online[e]=!1);var s=new Date(1e3*i.lastseen.main).toGMTString(),o=(Math.round(+new Date/1e3)-i.lastseen.main)/60;$("td",t).eq(2).html(o>30240?'<span class="label label-success" rel="tooltip" data-placement="top" title="'+s+'">Неактивен</span></li>':'<span class="label label-default" rel="tooltip" data-placement="top" title="'+s+'">'+jQuery.timeago(1e3*i.lastseen.main)+"</span></li>")}},error:function(){alert("Невозможно получить информацию о пользователе.")}})},100*e)}),this}};$("button#delete").click(function(){var e=$(this).parents("tr"),t=$(e).attr("id");$.ajax({url:"/see/delete",type:"GET",data:{id:t},success:function(){$(e).fadeOut(300,function(){$(this).remove()})},error:function(){alert("Ошибка при удалении пользователя.")}})}),$("#permission").click(function(){$(".alert").removeClass("visible").addClass("hidden"),"default"===Notification.permission&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e),"granted"===e&&new Notification("Спасибо!",{lang:"ru-RU",body:"Теперь мы можем посылать вам уведомления, когда пользователь зайдет поиграть."})})}),$(document).ready(function(){$(".table > tbody td.status").spin("show"),"Notification"in window?"granted"===Notification.permission?console.log("С уведомлениями все впорядке."):$(".alert").removeClass("hidden").addClass("visible"):alert("Ваш браузер не поддерживает HTML5 Notifications"),user.update(),setInterval(function(){user.update()},18e4)});
